apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "jsa-infrasec.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "jsa-infrasec.labels" . | nindent 4 }}
data:
  config.yaml: |
    # JSA-INFRASEC Configuration
    # Generated by Helm at {{ now | date "2006-01-02T15:04:05Z07:00" }}

    agent:
      name: {{ .Values.agent.name | quote }}
      rank: {{ .Values.agent.rank | quote }}
      autoFix: {{ .Values.agent.autoFix }}
      confidenceThreshold: {{ .Values.agent.confidenceThreshold }}
      scanInterval: {{ .Values.agent.scanInterval }}
      dryRun: {{ .Values.agent.dryRun }}
      maxConcurrentFixes: {{ .Values.agent.maxConcurrentFixes }}

    gpApi:
      endpoint: {{ .Values.gpApi.endpoint | quote }}
      findingsEndpoint: {{ .Values.gpApi.findingsEndpoint | quote }}
      batchEndpoint: {{ .Values.gpApi.batchEndpoint | quote }}
      healthEndpoint: {{ .Values.gpApi.healthEndpoint | quote }}
      enabled: {{ .Values.gpApi.enabled }}
      timeout: {{ .Values.gpApi.timeout }}
      retries: {{ .Values.gpApi.retries }}
      retryDelay: {{ .Values.gpApi.retryDelay }}

    logging:
      level: {{ .Values.logging.level | quote }}
      format: {{ .Values.logging.format | quote }}
      file:
        enabled: {{ .Values.logging.file.enabled }}
        path: {{ .Values.logging.file.path | quote }}

    domains:
      kubernetes:
        enabled: {{ .Values.domains.kubernetes.enabled }}
        namespaces: {{ toJson .Values.domains.kubernetes.namespaces }}
        excludeNamespaces: {{ toJson .Values.domains.kubernetes.excludeNamespaces }}
      policy:
        enabled: {{ .Values.domains.policy.enabled }}
        frameworks:
          opa: {{ .Values.domains.policy.frameworks.opa }}
          gatekeeper: {{ .Values.domains.policy.frameworks.gatekeeper }}
          kyverno: {{ .Values.domains.policy.frameworks.kyverno }}
          conftest: {{ .Values.domains.policy.frameworks.conftest }}
      iac:
        enabled: {{ .Values.domains.iac.enabled }}
        providers:
          terraform: {{ .Values.domains.iac.providers.terraform }}
          cloudformation: {{ .Values.domains.iac.providers.cloudformation }}
      cloud:
        enabled: {{ .Values.domains.cloud.enabled }}
        providers:
          aws:
            enabled: {{ .Values.domains.cloud.providers.aws.enabled }}
          azure:
            enabled: {{ .Values.domains.cloud.providers.azure.enabled }}
          gcp:
            enabled: {{ .Values.domains.cloud.providers.gcp.enabled }}
      secrets:
        enabled: {{ .Values.domains.secrets.enabled }}
        providers:
          vault: {{ .Values.domains.secrets.providers.vault }}
          awsSecretsManager: {{ .Values.domains.secrets.providers.awsSecretsManager }}
          k8sSecrets: {{ .Values.domains.secrets.providers.k8sSecrets }}
      compliance:
        enabled: {{ .Values.domains.compliance.enabled }}
        frameworks:
          cis: {{ .Values.domains.compliance.frameworks.cis }}
          nist: {{ .Values.domains.compliance.frameworks.nist }}
          soc2: {{ .Values.domains.compliance.frameworks.soc2 }}

    metrics:
      enabled: {{ .Values.metrics.enabled }}
      port: {{ .Values.metrics.port }}
